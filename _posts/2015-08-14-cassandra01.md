---
layout:     post
title:      "Cassandra使用笔记（1）"
subtitle:   "basic concepts"
date:       2015-08-08 17:35:00
author:     "Pete Kong"
header-img: "img/post-bg-02.jpg"
---

# Introduce

Cassandra 是一个水平扩展性很强、高可用的nosql数据库，其他介绍就不说了，可以在官网上找到。而本系列的笔记将介绍cassandra的架构（虽然很多只是翻译）开始，在介绍其使用方法。

# Understanding Architecture

## 术语

* Node
	存储数据的节点
* Data center
	相关nodes的集合，一个data center可能有一个物理或者虚拟的DC组成。不同的workloads?应该使用分离的DC。Replication也是基于DC层面。通过使用分离的DC，可以隔离不同workload的对cassandra事务的影响，并且可以保持相关的请求发送到同一个DC上，从而保证低latency。通过replication的配置，数据可以写到多个data center。但是，data centers不能分散于不同的物理位置。
* Cluster
	一个cluster包含了一个或多个data centers，它可以跨越多个物理位置。
* Commit log
	所有数据会先写到commit log去持久化。当所有这些数据flush到SSTables后，commit log就会被replica、删除或再循环。
* Table
	有序列的集合。每一行包含若干列，并且有一个主键，键的第一部分是一个列的名字。
* SSTable
	SSTable: sorted string table，它是一个不可变的数据文件，cassadra定期把memtables写到这个文件里。它是一个append only的文件，并且每一个cassandra table都维护一份。

## 架构简述

cassandra是使用多nodes处理大数据流并且没有单点故障而设计的系统。cassandra节点每秒都会跨cluster地叫唤信息。每次持续的写操作都会写commit log来持久化数据。然后数据会被建立索引并写到一个内存数据结构上：memtable。当memtable满了，数据将会写到SSTables上。所有写操作都是自动分区，并且在cluster里自动做复制replica。

cassandra是一个面向行的数据库，它允许任何已授权用户连接节点并使用CQL访问数据。CQL的语法类似SQL。一般地，一个cluster对每一个application有一个keyspace，

client可以向cluster里任何一个node进行读和写。当一个client连接了一个node并向它发出读写请求，这个node会作为一个coordinator（协调者）或者一个代理一样把请求转发给合适的node（取决于cluster的配置）。

## 配置cassandra的关键components

* Groosip
	它是一个节点之间点对点的通讯协议，它用于发现和共享节点的位置和状态信息。每当节点重启的时候，gossip信息就会被持久化。
* Partitioner
	parttitioner用于决定把数据分发到哪个节点，以及决定数据的第一个replica存放到哪里。一般地，partitioner是一个哈希函数，这哈希函数用于计算一个partition key的token，而每一行数据是用partition key来唯一标识。并通过这个token值来分发到cluster的节点中。默认的partioning策略是Murmur3Partitioner，你必须为每一个node配置一个num_toknes值。tokens的数量取决于硬件的能力。
* Replication factor
	repliaction factor是指在cluster里数据的replica数。如果replication factor是1，那么在一个节点中，每一行数据就会只有一个replica。如果是2，那么就有两个replica，而且分布在不同的节点上。你需要为每个DC设置replication factor,而且大于1，但不大于cluster的节点数。
* Snitch
	snitch是在racks(机架)和data center里定义的分组，指定组上使用的replication策略。所有snitches使用一个动态snitch层，它用于监控性能，当处理读请求时，它会选择一个性能最好的节点来读取replica。
	默认的SimpleSnitch不会识别data center或者rack的信息，当只有单个data center或者单zone的时候使用。在生产环境上推荐使用 GossipingPropertyFileSnitch，它定义了一个节点的data center和rack的信息，并且使用groosip协议收集其他节点的信息。
