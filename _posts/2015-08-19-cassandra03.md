---
layout:     post
title:      "Cassandra使用笔记（3）"
subtitle:   "Database internals"
date:       2015-08-19 19:35:00
author:     "Pete Kong"
header-img: "img/post-bg-02.jpg"
---

# Cassandra存储基础
-----------------
## write path to compaction

Cassandra的写路径会包含以下几个阶段，从记录写日志开始，到compaction结束。

1. 记录写日志和memtable存储

	当发生写操作，cassandra会把数据存储到一个在内存中叫memtable的数据结构里，同时把写操作append到磁盘的commit log里，即使断电了，commit log都会保留。memtable会保存写数据直到达到阈值，然后flush。

2. 从memtable flush到磁盘

	当memtable的内容超过配置的阈值，memtable的数据（包括索引）就会放到队列里等待flush到磁盘。你也可以配置queue的大小：memtable_heap_space_in_mb .如果队列也满了，那么写操作将会被阻塞直到flush成功。你也可以手工的调nodetool flush命令来flush。在重启节点之前，一般都需要手工flush memtable，以减少commit log replay的时间。

3。 吧数据保存到磁盘上的SSTables
	
	当memtable的数据被flush到SSTable后，commit log也会被清除。
	![storage]({{ site.baseurl }}/img/cassandra03/storage_basic.png)

	Memtables和SSTables为每个table维护一份。SSTtables是不可变的，在memtable flush过去之后就不会被修改，因此，一个partition一般会存储在多个SSTable文件里。

4. Compaction
	
	cassandra会定期的进行数据压缩，因为当发生update/insert时，cassandra不会针对找到需要修改的数据的位置去进行重写，只会在另一个SSTable里新加一条数据，并加上version信息。因此，cassandra需要对不断累积的SSTable进行压缩。

	同样，delete也是不会在SSTable里把数据删除，而是使用tombstone来标记数据将要被删除。Tomstone会保存一段时间，它是由gc_grace_seconds这个配置项定义。

	在压缩过程中，磁盘利用率会达到一个临时的峰值，下图描述了压缩的过程：
	![compaction]({{ site.baseurl }}/img/cassandra03/compaction.png)

	压缩过程中，每个SSTable里的数据会根据partition key进行合并，根据timestamp选取最新的那条数据。cassandra合并数据是非常高效的，因为在每个SSTable里的行都是根据partition key来排序。删除完被标记了tombstones的数据，压缩进程会把SSTables更新到一个新的文件。就得SSTable则会在所有等待的读完成后删除。然后旧的SSTable所占空间则可被重用。

	你可以配置以下3种压缩类型：

	* [SizeTieredCompactionStrategy](http://docs.datastax.com/en/cql/3.1/cql/cql_reference/tabProp.html?scroll=tabProp__moreCompaction) : 业务类型是写敏感的
	* [LeveledCompactionStrategy](http://docs.datastax.com/en/cql/3.1/cql/cql_reference/tabProp.html?scroll=tabProp__moreCompaction) ：业务类型是读敏感的
	* [LeveledCompactionStrategy](http://docs.datastax.com/en/cql/3.1/cql/cql_reference/tabProp.html?scroll=tabProp__moreCompaction) ：[ time series data ](http://planetcassandra.org/blog/getting-started-with-time-series-data-modeling/) 和 [expiring (TTL) data](http://docs.datastax.com/en/cql/3.1/cql/cql_using/use_expire_c.html)